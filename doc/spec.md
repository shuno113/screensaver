# Bakery システム仕様書

## 1. 概要
Bakeryシステムは、ファイルを視覚的なグレースケールフレームのシーケンス（動画）に変換し、エアギャップ環境からのデータサーブを可能にするシステムである。
本システムは、送信側（bake）と受信側（taste）で共通のプロトコルを使用してデータをサーブする。

## 2. 共通プロトコル仕様

### 2.1. 画面構成と解像度
システムは、1080p (1920x1080) の物理ディスプレイまたは動画ファイルを伝送媒体として使用する。

*   **物理出力解像度**: 1920 x 1080 ピクセル
*   **論理解像度**: 960 x 540 ブロック
*   **ブロックサイズ**: 1論理ピクセルあたり 2x2 物理ピクセル

各 "論理ピクセル" は、画面上の 2x2 の物理ピクセル領域に対応し、単一のグレースケール値を持つ。

### 2.2. エンコーディング方式
バイナリデータは、以下のルールに従って視覚データに変換される。

*   **色深度**: 4-bit (16階調)。0〜15の値を0〜255のグレースケール輝度に等間隔でマッピングする。
*   **ニブル (Nibble)**: 1バイト (8-bit) を 上位4-bit (High) と 下位4-bit (Low) の2つのニブルに分割する。
*   **冗長性 (Repetition)**: エラー耐性を高めるため、各ニブルを **2回** 繰り返す。
    *   送信順序: `[High, High, Low, Low]`
*   **ピクセル効率**: 1バイトあたり 4 論理ピクセルを使用。

### 2.3. フレームレイアウト
*   **データ領域**: 960x540 のグリッド全体を使用する。
*   **コーナーマーカー**: 4隅の論理ピクセル (左上、右上、左下、右下) は、位置合わせおよび同期検出用として**常に白 (輝度255)** に固定される。これらのピクセルにはデータを含めない。

### 2.4. データコンテナ構造
伝送されるデータ本体は、以下の構造を持つ「データブロック」として構成される。

| オフセット | サイズ | フィールド | 値/説明 |
| :--- | :--- | :--- | :--- |
| 0 | 4 | Magic | `b"FVD1"` |
| 4 | 4 | Header Size | `256` (uint32, big-endian) |
| 8 | 8 | File Size | 元ファイルのサイズ (uint64, big-endian) |
| 16 | 32 | File Hash | 元ファイルのSHA-256ハッシュ |
| 48 | 1 | Name Len | ファイル名のバイト長 ($N$) |
| 49 | $N$ | Filename | UTF-8 エンコードされたファイル名 |
| ... | ... | Padding | 256バイト目までゼロ埋め |
| 256 | $S$ | File Data | 実際のファイルコンテンツ |

### 2.5. キーフレーム仕様
データフレームの前後にキーフレームを挿入し、デコード時の自動検出を可能にする。

| 種別 | 色 | RGB値 | 持続時間 |
| :--- | :--- | :--- | :--- |
| 開始キーフレーム | 緑 | `(0, 255, 0)` | 1秒 (FPS枚) |
| 終了キーフレーム | 赤 | `(255, 0, 0)` | 1秒 (FPS枚) |

*   **検出閾値**: 
    *   開始: G > 200、R < 50、B < 50
    *   終了: R > 200、G < 50、B < 50
*   **フレーム順序**: `[開始キーフレーム] → [データフレーム...] → [終了キーフレーム]`
*   **デコード時**: キーフレーム外の内容は無視される

### 2.6. デコード堅牢化仕様
外部キャプチャ環境での信頼性確保のため、以下の処理を行う。

*   **遷移フレームスキップ**: キーフレーム直後、コーナー値が安定（≥160）かつ次フレームと内容一致するまでスキップ。
*   **ブロック平均リサイズ**: 物理解像度から論理解像度への変換にブロック平均法を使用（ティアリング軽減）。
*   **フレーム選択**: 類似フレームをグループ化し、コーナー値が閾値（180）以上の最高品質フレームを選択。
*   **輝度補正**: 4コーナーの最大値を白（255）として全体をスケーリング。

